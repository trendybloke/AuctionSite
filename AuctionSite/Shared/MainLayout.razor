@inherits LayoutComponentBase

@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using AuctionSite.Data
@using AuctionSite.Helpers
@using System.Security.Claims

@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject ProtectedLocalStorage SessionStore

<PageTitle>AuctionSite</PageTitle>

<MudLayout>
    <MudAppBar Elevation="1" Color="Color.Primary">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@ToggleSide" />
        <MudSpacer />
        <AuctionSearchBar />
        <MudSpacer />
        <BalanceDisplay />
        <NotificationDisplay @ref="notifDisplay"/>
    </MudAppBar>
    <MudDrawer @bind-Open="@sideOpen" Elevation="1">
        <MudDrawerHeader>
            <LoginDisplay />
        </MudDrawerHeader>
        <NavMenu />
        <MudSpacer />
        <MudSwitch T="bool" CheckedChanged="ToggleDarkTheme" Label="Dark theme" Class="pl-4"/>
    </MudDrawer>
    <MudMainContent>
        <MudContainer Style="padding-top: 20px">
            @Body
        </MudContainer>

        <!-- MudBlazor reqs. -->
        <MudThemeProvider IsDarkMode="@darkMode"/>
        <MudDialogProvider />
        <MudSnackbarProvider />
    </MudMainContent>
</MudLayout>

@code {
    bool sideOpen = false;

    bool darkMode;

    void ToggleSide() => sideOpen = !sideOpen;

    private HubConnection? hubConnection;

    private NotificationDisplay notifDisplay;

    [CascadingParameter]
    protected Task<AuthenticationState> AuthenticationStateTask { get; set; }

    protected ClaimsPrincipal? CurrentUser
    {
        get
        {
            var authState = AuthenticationStateTask.Result;
            var user = authState.User;
            return user;
        }
    }

    async Task ToggleDarkTheme()
    {
        darkMode = !darkMode;

        await SessionStore.SetAsync("DarkMode", darkMode);
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();


        hubConnection = new HubConnectionBuilder()
                            .WithUrl(Navigation.ToAbsoluteUri("/BiddingHub"))
                            .Build();

        hubConnection.On<NotificationModel>("NewNotification", (newNotif) =>
        {
            Snackbar.Add(newNotif.Content, newNotif.Severity);

            notifDisplay.PopulateNotifications(CurrentUser.GetUserID());

            InvokeAsync(StateHasChanged);
        });
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        if (firstRender)
        {
            var isDark = await SessionStore.GetAsync<bool>("DarkMode");

            darkMode = isDark.Success ? isDark.Value : false;
        }

        await InvokeAsync(StateHasChanged);
    }

    protected override void OnAfterRender(bool firstRender)
    {
        // Notif Display is enabled if a user is logged in.
        notifDisplay.SetEnabled(!String.IsNullOrEmpty(CurrentUser.GetUserID()));

        if (notifDisplay.Enabled && firstRender)
        {
            notifDisplay.PopulateNotifications(CurrentUser.GetUserID());
        }
        
        InvokeAsync(StateHasChanged);
    }
}